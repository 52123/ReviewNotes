## 一、常用术语总结

| 名词              | 概念                                                         |
| ----------------- | :----------------------------------------------------------- |
| PCB               | 进程控制块（PCB Process Control Block）,系统中存放、管理和控制进程信息的数据结构称为PCB<br />OS是根据PCB来对并发执行的进程进行控制管理的 |
| TCB               | 线程控制块                                                   |
| FCB               | 文件控制块                                                   |
| PID               | 进程ID(Process ID)                                           |
| PSW               | 程序状态字寄存器，用于存放PC、IR等的信息                     |
| PC                | 程序计数器，存放下一条指令地址                               |
| IR                | 指令寄存器，存放到当前进行的指令                             |
| 半双工            | 半双工和全双工是计算机网络中的概念，意思是通讯同一时间只允许一方发送数据(对讲机) |
| 全双工            | 通信允许两方向上同时传输数据(电话)                           |
| P操作             | 来自荷兰语proveren，代表wait原语，通常使用P(S)代替wait(S)    |
| V操作             | 来自荷兰语verhogen，代表原语signal,通常使用V(S)代替signal(S) |
| 用户态            | 一般的操作系统对执行权限进行分级，分别为用保护态和内核态。用户态相较于内核态有较低的执行权限，很多操作是不被操作系统允许的，从而保证操作系统和计算机的安全。 |
| 内核态            | 内核态相当于一个介于硬件与应用之间的层，可以进行硬件的调度、使用，可以执行任何cpu指令，也可以引用任何内存地址，包括外围设备, 例如硬盘, 网卡，权限等级最高。 |
| 用户态内核态切换  | 三种情况下，用户态会转换到内核态，`系统调用、程序异常(例如/0，内存资源耗尽等)、来自外围设备的中断` |
| 系统调用/程序接口 | 用户程序通过系统调用的方式才能对硬件进行使用，或者说操作系统将使用硬件的接口提供给用户程序 |
| 中断              | 中断是操作系统内核程序夺取cpu的唯一途径，或者说用户程序调用内核代码的唯一途径，因为在一般情况下，操作系统会将cpu使用权交给应用程序。 |



## 二、进程、线程

### 2.1 进程

进程由**PCB、程序段、数据段**组成，包含了PID、资源分配情况、进程运行情况。

对用户而言，我们能看到**一个个PID**，而对操作系统而言，底层需要处理的是**一个个PCB**。



PCB包括：

- 程序计数器：接着要运行的指令地址
- 进程状态：可以是new、ready、running、waiting或blocking
- CPU暂存器：主要用于中断时，暂时存储数据，以便稍后继续利用
- 存储器管理：如标签页等



程序段： 存放要执行的代码

数据段：存放程序运行过程中处理的各种数据



#### 2.1.1 进程控制

进程控制的原语：**创建、终止、阻塞、唤醒、切换**。

原语的执行具有原子性，不允许被中断，原语的实现可以通过“关中断指令”和“开中断指令”实现



进程状态（三态模型）：**运行态、就绪态、阻塞态**

进程状态转换的条件：

- 运行 -> 阻塞：等待IO或事件完成
- 运行 -> 就绪：进程的CPU时间片用完了
- 就绪 -> 运行：获得了CPU的时间片
- 阻塞 -> 就绪：IO或事件完成了



![进程状态流程图](../docs/进程状态流程图.png)



#### 2.1.2 进程的组织形式

> 在一个系统中，通常有数十、数百乃至数千个PCB。为了能对他们加以有效的管理，应该用适当的方式把这些PCB组织起来。

![链接方式](../docs/链接方式.png)



![索引方式](../docs/索引方式.png)



#### 2.1.3 进程间通信

进程通信是指进程之间的信息交换。进程是分配系统资源的单位，因此各个进程拥有的内存地址相互独立，为了保证安全，一个进程不能直接访问另一个进程的地址空间



进程通信方法：**共享存储、信号量、消息队列/信箱、管道通信、套接字(这个在计算机网络有涉及相关知识，可以把套接字理解为一个窗口)**



##### 2.1.3.1 共享存储

基于数据结构的共享：比如共享空间内只能放一个长度为10 的数组，这种方式速度慢、限制多，是一种低级通信

**基于存储区的共享**：在内存中划分一块共享内存，数据的形式、存放位置都由进程来控制。相比之下速度更快，是一种高级通信



两个进程对共享空间的访问必须是互斥的



##### 2.1.3.2 消息传递

通过原语控制，进程1发送消息到消息缓冲队列或者信箱中，进程2从消息队列或者信箱中接收消息。



消息由消息头和消息体构成。

消息头：发送进程ID、接受进程ID、消息类型、消息长度等格式化的信息



消息传递的方式有直接通信和间接通信

直接通信：消息直接挂到接收进程的消息缓冲队列中

间接通信：消息要先发到中间实体（信箱中）

![进程的消息传递](../docs/进程的消息传递.png)



##### 2.1.3.3 管道通信

“管道”是指用于连接读写进程的一个共享文件。其实就是在内存中开辟了一个大小固定的缓冲区



1. 管道只能采用**半双工通信**，某一段时间段内只能实现单向的传输。如果要实现双向同时通信，需要设置两个管道
2. 各个进程要互斥地访问管道
3. 数据以字符流的形式写入管道，当管道写满时，写进程的write()系统调用将会阻塞，等待读进程将数据取走。同理，管道为空时，读进程的read()系统调用将会阻塞
4. 如果没写满，则不允许读，如果没读空，就不允许写
5. 数据一旦被读出，就从管道中被丢弃，就意味着读进程最多只有一个。
6. 缓冲区大小有限，默认4k
7. 只能用于亲缘关系的进程



##### 2.1.3.4 命名管道

命名管道不同于匿名管道之处在于它提供了一个路径名与之关联，以命名管道的文件形式存在于文件系统中。这样，即使与命名管道的创建进程不存在亲缘关系的进程，只要可以访问该路径，就能够彼此通过命名管道相互通信



###### 匿名管道和命名管道总结

1. 管道是特殊类型的文件，在满足先入先出的原则条件下可以进行读写，但不能进行定位读写。
2. 匿名管道是单向的，只能在有亲缘关系的进程间通信；有名管道以磁盘文件的方式存在，可以实现本机任意两个进程通信。
3. 无名管道阻塞问题：无名管道无需显示打开，创建时直接返回文件描述符，在读写时需要确定对方的存在，否则将退出。如果当前进程向无名管道的一端写数据，必须确定另一端有某一进程。如果写入无名管道的数据超过其最大值，写操作将阻塞，如果管道中没有数据，读操作将阻塞，如果管道发现另一端断开，将自动退出。
4. 命名管道阻塞问题：命名管道在打开时需要确实对方的存在，否则将阻塞。即以读方式打开某管道，在此之前必须一个进程以写方式打开管道，否则阻塞。此外，可以以读写（O_RDWR）模式打开命名管道，即当前进程读，当前进程写，不会阻塞。





### 2.2 线程

进程是资源分配的基本单位，线程是调度的基本单位，往往一个进程包含多个线程。线程并发，系统开销小，不需要切换系统资源